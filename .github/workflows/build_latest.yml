name: Build and release 'latest'

on:
    push:
        branches:
            - master
    workflow_dispatch:

permissions:
    contents: write

jobs:
    build-and-release:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up JDK 23
              uses: actions/setup-java@v4
              with:
                distribution: temurin
                java-version: '23'

            - name: Build (detect mvn/gradle)
              run: |
                    if [ -f mvnw ]; then
                        chmod +x mvnw
                        ./mvnw -B -DskipTests package
                    elif [ -f pom.xml ]; then
                        mvn -B -DskipTests package
                    elif [ -f gradlew ]; then
                        chmod +x gradlew
                        ./gradlew -x test build
                    elif [ -f build.gradle ] || [ -f build.gradle.kts ]; then
                        ./gradlew -x test build
                    else
                        echo "No recognized Java build system (pom.xml, mvnw, gradlew) found."
                        exit 1
                    fi

            - name: Find built JAR
              id: find_artifact
              run: |
                    jar=$(find . -type f -name "*.jar" -not -path "*/.gradle/*" -not -path "*/.mvn/*" | head -n1 || true)
                    if [ -z "$jar" ]; then
                        echo "No JAR artifact found"
                        exit 1
                    fi
                    echo "jar_path=$jar" >> $GITHUB_OUTPUT

            - name: Create or update tag 'latest'
              run: |
                    git config user.name "github-actions[bot]"
                    git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
                    # Tag the current HEAD as 'latest' and force-push the tag to origin
                    git tag -fa latest -m "latest"
                    git push --force origin refs/tags/latest

            - name: Prepare release asset
              id: prep_asset
              run: |
                jar_path="${{ steps.find_artifact.outputs.jar_path }}"
                echo "asset_path=$jar_path" >> $GITHUB_OUTPUT
                echo "asset_name=$(basename \"$jar_path\")" >> $GITHUB_OUTPUT

            - name: Create GitHub release
              id: create_release
              uses: actions/create-release@v1
              env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                tag_name: latest
                release_name: latest
                body: Release latest
                draft: false
                prerelease: false

            - name: Upload release asset
              uses: actions/upload-release-asset@v1
              env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                upload_url: ${{ steps.create_release.outputs.upload_url }}
                asset_path: ${{ steps.prep_asset.outputs.asset_path }}
                asset_name: ${{ steps.prep_asset.outputs.asset_name }}
                asset_content_type: application/java-archive